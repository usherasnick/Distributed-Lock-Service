## 搭建MySQL主从架构

1. 创建主从架构可用的网络环境

```shell
docker network create mysql-primary-replica --subnet=192.168.0.0/24
```

2. 先启动主节点

```shell
docker run --name=mysql_primary \
    --net=mysql-primary-replica \
    --ip=192.168.0.2 \
    -e MYSQL_ROOT_PASSWORD='Pwd123!@' \
    -p 13306:3306 \
    -v $PWD/conf.d:/etc/mysql/conf.d \
    -d mysql:8.0
```

3. 进入主节点容器做一些准备工作

``` shell
mysql -uroot -p

# 查看主节点状态
SHOW MASTER STATUS;
# 创建同步账号
USE mysql;
CREATE USER 'sync-binlog'@'192.168.0.3' IDENTIFIED WITH mysql_native_password BY 'sync';
CREATE USER 'sync-binlog'@'192.168.0.4' IDENTIFIED WITH mysql_native_password BY 'sync';
# 检查下是否创建成功
SELECT User FROM user;
# 授予 REPLICATION SLAVE 权限, 192.168.0.3为从节点IP
GRANT REPLICATION SLAVE ON *.* TO 'sync-binlog'@'192.168.0.3';
GRANT REPLICATION SLAVE ON *.* TO 'sync-binlog'@'192.168.0.4';
FLUSH PRIVILEGES;
```

4. 再启动一个从节点

```shell
docker run --name=mysql_replica_01 \
    --net=mysql-primary-replica \
    --ip=192.168.0.3 \
    -e MYSQL_ROOT_PASSWORD='Pwd123!@' \
    -d mysql:8.0 --server-id=2
```

5. 进入从节点容器做一些准备工作

``` shell
mysql -uroot -p

# 设置主节点参数
CHANGE MASTER TO MASTER_HOST='192.168.0.2',MASTER_USER='sync-binlog',MASTER_PASSWORD='sync',MASTER_LOG_FILE='binlog.000002',MASTER_LOG_POS=875;
# 查看从节点状态
SHOW SLAVE STATUS;
# 开启主从同步
START SLAVE;
# 再次查看从节点状态
SHOW SLAVE STATUS;
```

```text
+----------------------------------+-------------+-------------+-------------+---------------+-----------------+---------------------+-------------------------------+---------------+-----------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+--------------------------------------+-------------------------+-----------+---------------------+--------------------------------------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+------------------------+-----------------------+-------------------+
| Slave_IO_State                   | Master_Host | Master_User | Master_Port | Connect_Retry | Master_Log_File | Read_Master_Log_Pos | Relay_Log_File                | Relay_Log_Pos | Relay_Master_Log_File | Slave_IO_Running | Slave_SQL_Running | Replicate_Do_DB | Replicate_Ignore_DB | Replicate_Do_Table | Replicate_Ignore_Table | Replicate_Wild_Do_Table | Replicate_Wild_Ignore_Table | Last_Errno | Last_Error | Skip_Counter | Exec_Master_Log_Pos | Relay_Log_Space | Until_Condition | Until_Log_File | Until_Log_Pos | Master_SSL_Allowed | Master_SSL_CA_File | Master_SSL_CA_Path | Master_SSL_Cert | Master_SSL_Cipher | Master_SSL_Key | Seconds_Behind_Master | Master_SSL_Verify_Server_Cert | Last_IO_Errno | Last_IO_Error | Last_SQL_Errno | Last_SQL_Error | Replicate_Ignore_Server_Ids | Master_Server_Id | Master_UUID                          | Master_Info_File        | SQL_Delay | SQL_Remaining_Delay | Slave_SQL_Running_State                                | Master_Retry_Count | Master_Bind | Last_IO_Error_Timestamp | Last_SQL_Error_Timestamp | Master_SSL_Crl | Master_SSL_Crlpath | Retrieved_Gtid_Set | Executed_Gtid_Set | Auto_Position | Replicate_Rewrite_DB | Channel_Name | Master_TLS_Version | Master_public_key_path | Get_master_public_key | Network_Namespace |
+----------------------------------+-------------+-------------+-------------+---------------+-----------------+---------------------+-------------------------------+---------------+-----------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+--------------------------------------+-------------------------+-----------+---------------------+--------------------------------------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+------------------------+-----------------------+-------------------+
| Waiting for master to send event | 192.168.0.2 | sync-binlog |        3306 |            60 | binlog.000002   |                 875 | 81ee1bf96424-relay-bin.000002 |           321 | binlog.000002         | Yes              | Yes               |                 |                     |                    |                        |                         |                             |          0 |            |            0 |                 875 |             537 | None            |                |             0 | No                 |                    |                    |                 |                   |                |                     0 | No                            |             0 |               |              0 |                |                             |                1 | f2b29f06-4457-11eb-996e-0242c0a80002 | mysql.slave_master_info |         0 |                NULL | Slave has read all relay log; waiting for more updates |              86400 |             |                         |                          |                |                    |                    |                   |             0 |                      |              |                    |                        |                     0 |                   |
+----------------------------------+-------------+-------------+-------------+---------------+-----------------+---------------------+-------------------------------+---------------+-----------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+--------------------------------------+-------------------------+-----------+---------------------+--------------------------------------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+------------------------+-----------------------+-------------------+
```

6. 再启动一个从节点

```shell
docker run --name=mysql_replica_02 \
    --net=mysql-primary-replica \
    --ip=192.168.0.4 \
    -e MYSQL_ROOT_PASSWORD='Pwd123!@' \
    -d mysql:8.0 --server-id=3
```

7. 进入从节点容器做一些准备工作

``` shell
mysql -uroot -p

# 设置主节点参数
CHANGE MASTER TO MASTER_HOST='192.168.0.2',MASTER_USER='sync-binlog',MASTER_PASSWORD='sync',MASTER_LOG_FILE='binlog.000002',MASTER_LOG_POS=875;
# 查看从节点状态
SHOW SLAVE STATUS;
# 开启主从同步
START SLAVE;
# 再次查看从节点状态
SHOW SLAVE STATUS;
```

```text
+----------------------------------+-------------+-------------+-------------+---------------+-----------------+---------------------+-------------------------------+---------------+-----------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+--------------------------------------+-------------------------+-----------+---------------------+--------------------------------------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+------------------------+-----------------------+-------------------+
| Slave_IO_State                   | Master_Host | Master_User | Master_Port | Connect_Retry | Master_Log_File | Read_Master_Log_Pos | Relay_Log_File                | Relay_Log_Pos | Relay_Master_Log_File | Slave_IO_Running | Slave_SQL_Running | Replicate_Do_DB | Replicate_Ignore_DB | Replicate_Do_Table | Replicate_Ignore_Table | Replicate_Wild_Do_Table | Replicate_Wild_Ignore_Table | Last_Errno | Last_Error | Skip_Counter | Exec_Master_Log_Pos | Relay_Log_Space | Until_Condition | Until_Log_File | Until_Log_Pos | Master_SSL_Allowed | Master_SSL_CA_File | Master_SSL_CA_Path | Master_SSL_Cert | Master_SSL_Cipher | Master_SSL_Key | Seconds_Behind_Master | Master_SSL_Verify_Server_Cert | Last_IO_Errno | Last_IO_Error | Last_SQL_Errno | Last_SQL_Error | Replicate_Ignore_Server_Ids | Master_Server_Id | Master_UUID                          | Master_Info_File        | SQL_Delay | SQL_Remaining_Delay | Slave_SQL_Running_State                                | Master_Retry_Count | Master_Bind | Last_IO_Error_Timestamp | Last_SQL_Error_Timestamp | Master_SSL_Crl | Master_SSL_Crlpath | Retrieved_Gtid_Set | Executed_Gtid_Set | Auto_Position | Replicate_Rewrite_DB | Channel_Name | Master_TLS_Version | Master_public_key_path | Get_master_public_key | Network_Namespace |
+----------------------------------+-------------+-------------+-------------+---------------+-----------------+---------------------+-------------------------------+---------------+-----------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+--------------------------------------+-------------------------+-----------+---------------------+--------------------------------------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+------------------------+-----------------------+-------------------+
| Waiting for master to send event | 192.168.0.2 | sync-binlog |        3306 |            60 | binlog.000002   |                1779 | 2c81e7dfa5c4-relay-bin.000002 |          1225 | binlog.000002         | Yes              | Yes               |                 |                     |                    |                        |                         |                             |          0 |            |            0 |                1779 |            1441 | None            |                |             0 | No                 |                    |                    |                 |                   |                |                     0 | No                            |             0 |               |              0 |                |                             |                1 | f2b29f06-4457-11eb-996e-0242c0a80002 | mysql.slave_master_info |         0 |                NULL | Slave has read all relay log; waiting for more updates |              86400 |             |                         |                          |                |                    |                    |                   |             0 |                      |              |                    |                        |                     0 |                   |
+----------------------------------+-------------+-------------+-------------+---------------+-----------------+---------------------+-------------------------------+---------------+-----------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+--------------------------------------+-------------------------+-----------+---------------------+--------------------------------------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+------------------------+-----------------------+-------------------+
```